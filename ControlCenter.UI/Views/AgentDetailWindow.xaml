<Window x:Class="ControlCenter.UI.Views.AgentDetailWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:ControlCenter.UI.Views"
        mc:Ignorable="d"
        Title="Dettagli Agente" Height="500" Width="600"
        WindowStartupLocation="CenterOwner"
        Background="{StaticResource IndigoLightGrayBrush}">
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Titolo -->
        <TextBlock Grid.Row="0" 
                  Text="{Binding Agent.Name}" 
                  Style="{StaticResource TitleTextStyle}" 
                  Margin="0,0,0,20"/>
        
        <!-- Contenuto -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                <!-- Info Base -->
                <Border Style="{StaticResource CardBorderStyle}" Margin="0,0,0,15">
                    <StackPanel>
                        <TextBlock Text="Informazioni Base" Style="{StaticResource SubtitleTextStyle}" Margin="0,0,0,10"/>
                        
                        <TextBlock Margin="0,5">
                            <Run Text="Nome: " FontWeight="SemiBold"/>
                            <Run Text="{Binding Agent.Name, Mode=OneWay}"/>
                        </TextBlock>
                        
                        <TextBlock Margin="0,5">
                            <Run Text="Tipo: " FontWeight="SemiBold"/>
                            <Run Text="{Binding Agent.Type, Mode=OneWay}"/>
                        </TextBlock>
                        
                        <TextBlock Margin="0,5">
                            <Run Text="Porta: " FontWeight="SemiBold"/>
                            <Run Text="{Binding Agent.Port, Mode=OneWay}"/>
                        </TextBlock>
                        
                        <TextBlock Margin="0,5">
                            <Run Text="Status: " FontWeight="SemiBold"/>
                            <Run Text="{Binding Agent.Status, Mode=OneWay}" Foreground="{StaticResource IndigoPrimaryBrush}"/>
                        </TextBlock>
                    </StackPanel>
                </Border>
                
                <!-- Health Status -->
                <Border Style="{StaticResource CardBorderStyle}" Margin="0,0,0,15">
                    <StackPanel>
                        <TextBlock Text="Health Status" Style="{StaticResource SubtitleTextStyle}" Margin="0,0,0,10"/>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <Ellipse Grid.Column="0" 
                                    Width="16" 
                                    Height="16" 
                                    VerticalAlignment="Center"
                                    Margin="0,0,10,0"
                                    Fill="LimeGreen">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Agent.IsHealthy}" Value="False">
                                                <Setter Property="Fill" Value="Red"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            
                            <TextBlock Grid.Column="1" 
                                      Text="Healthy" 
                                      VerticalAlignment="Center"
                                      FontWeight="SemiBold">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Agent.IsHealthy}" Value="False">
                                                <Setter Property="Text" Value="Unhealthy"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>
                    </StackPanel>
                </Border>
                
                <!-- Risultato Test -->
                <Border Margin="10"
                       Padding="10"
                       CornerRadius="4"
                       Visibility="{Binding TestCompleted, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Background" Value="#FFEBEE"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding TestSuccess}" Value="True">
                                    <Setter Property="Background" Value="#E8F5E9"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    
                    <TextBlock Text="{Binding TestMessage}" 
                              TextWrapping="Wrap" 
                              FontFamily="Consolas" 
                              FontSize="12"/>
                </Border>
                
                <!-- Dispatch Task -->
                <Border Style="{StaticResource CardBorderStyle}" Margin="0,0,0,15">
                    <StackPanel>
                        <TextBlock Text="Dispatch Task" Style="{StaticResource SubtitleTextStyle}" Margin="0,0,0,10"/>
                        
                        <!-- Task Name -->
                        <TextBlock Text="Task Name:" FontWeight="SemiBold" Margin="0,5,0,5"/>
                        <TextBox Text="{Binding TaskName, UpdateSourceTrigger=PropertyChanged}" 
                                Padding="8"
                                IsEnabled="{Binding IsDispatching, Converter={StaticResource InverseBoolConverter}}"
                                BorderBrush="{StaticResource IndigoDarkBrush}"
                                Margin="0,0,0,10"/>
                        
                        <!-- Task Payload -->
                        <TextBlock Text="Payload (JSON):" FontWeight="SemiBold" Margin="0,5,0,5"/>
                        <TextBox Text="{Binding TaskPayload, UpdateSourceTrigger=PropertyChanged}" 
                                Padding="8"
                                MinHeight="60"
                                MaxHeight="100"
                                TextWrapping="Wrap"
                                AcceptsReturn="True"
                                VerticalScrollBarVisibility="Auto"
                                IsEnabled="{Binding IsDispatching, Converter={StaticResource InverseBoolConverter}}"
                                BorderBrush="{StaticResource IndigoDarkBrush}"
                                FontFamily="Consolas"
                                FontSize="11"
                                Margin="0,0,0,10"/>
                        
                        <!-- Dispatch Button -->
                        <StackPanel Orientation="Horizontal" Margin="0,5,0,10">
                            <Button Content="Dispatch Task"
                                   Command="{Binding DispatchTaskCommand}"
                                   IsEnabled="{Binding IsDispatching, Converter={StaticResource InverseBoolConverter}}"
                                   Background="{StaticResource IndigoPrimaryBrush}"
                                   Foreground="White"
                                   Padding="15,8"
                                   BorderThickness="0"
                                   Cursor="Hand"/>
                            
                            <TextBlock Text="Dispatchingâ€¦"
                                      VerticalAlignment="Center"
                                      FontSize="12"
                                      FontStyle="Italic"
                                      Foreground="{StaticResource IndigoPrimaryBrush}"
                                      Margin="10,0,0,0"
                                      Visibility="{Binding IsDispatching, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        </StackPanel>
                        
                        <!-- Risultato Dispatch -->
                        <Border Margin="0,5,0,0"
                               Padding="10"
                               CornerRadius="4"
                               Visibility="{Binding DispatchCompleted, Converter={StaticResource BoolToVisibilityConverter}}">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Background" Value="#FFEBEE"/>
                                    <Setter Property="BorderBrush" Value="#F44336"/>
                                    <Setter Property="BorderThickness" Value="2"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding DispatchSuccess}" Value="True">
                                            <Setter Property="Background" Value="#E8F5E9"/>
                                            <Setter Property="BorderBrush" Value="#4CAF50"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            
                            <TextBlock Text="{Binding DispatchMessage}" 
                                      TextWrapping="Wrap" 
                                      FontFamily="Consolas" 
                                      FontSize="12"/>
                        </Border>
                    </StackPanel>
                </Border>
                
                <!-- AI Task Result Panel -->
                <Border Style="{StaticResource CardBorderStyle}" 
                       Margin="0,0,0,15"
                       Visibility="{Binding IsAiTaskResult, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel>
                        <TextBlock Text="ðŸ§  Risultato Task AI" 
                                  Style="{StaticResource SubtitleTextStyle}" 
                                  Margin="0,0,0,15"
                                  Foreground="{StaticResource IndigoPrimaryBrush}"/>
                        
                        <!-- Flusso Operativo -->
                        <Border Background="#E3F2FD" 
                               Padding="15" 
                               CornerRadius="4" 
                               Margin="0,0,0,15">
                            <StackPanel>
                                <TextBlock Text="Flusso Operativo" 
                                          FontWeight="SemiBold" 
                                          FontSize="14" 
                                          Margin="0,0,0,10"/>
                                <StackPanel>
                                    <TextBlock Text="âœ“ Task ricevuto dall'Orchestrator" 
                                              Foreground="#4CAF50" 
                                              Margin="0,3"/>
                                    <TextBlock Text="âœ“ Instradato a AI Worker (IndigoAiWorker01)" 
                                              Foreground="#4CAF50" 
                                              Margin="0,3"/>
                                    <TextBlock Text="âœ“ Prompt ottimizzato generato" 
                                              Foreground="#4CAF50" 
                                              Margin="0,3"/>
                                    <TextBlock Text="âœ“ File salvato in CursorBridge" 
                                              Foreground="#4CAF50" 
                                              Margin="0,3"/>
                                    <TextBlock Text="âœ“ Pronto per Cursor AI Assistant" 
                                              Foreground="#4CAF50" 
                                              Margin="0,3"
                                              FontWeight="SemiBold"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                        
                        <!-- File Generato -->
                        <Border Background="#FFF9C4" 
                               Padding="15" 
                               CornerRadius="4" 
                               Margin="0,0,0,15">
                            <StackPanel>
                                <TextBlock Text="ðŸ“ File Generato" 
                                          FontWeight="SemiBold" 
                                          FontSize="14" 
                                          Margin="0,0,0,10"/>
                                <TextBlock TextWrapping="Wrap" Margin="0,5">
                                    <Run Text="Percorso:" FontWeight="SemiBold"/>
                                    <LineBreak/>
                                    <Run Text="{Binding AiTaskResult.CursorFilePath, Mode=OneWay}" 
                                         FontFamily="Consolas" 
                                         FontSize="11"/>
                                </TextBlock>
                                <Button Content="ðŸ“‚ Apri Cartella"
                                       Click="OpenCursorFolder_Click"
                                       Background="{StaticResource IndigoOrangeBrush}"
                                       Foreground="White"
                                       Padding="10,5"
                                       Margin="0,10,0,0"
                                       BorderThickness="0"
                                       Cursor="Hand"
                                       FontSize="12"
                                       HorizontalAlignment="Left"/>
                            </StackPanel>
                        </Border>
                        
                        <!-- Prompt Ottimizzato -->
                        <StackPanel Margin="0,0,0,15">
                            <TextBlock Text="ðŸ“ Prompt Ottimizzato" 
                                      FontWeight="SemiBold" 
                                      FontSize="14" 
                                      Margin="0,0,0,10"/>
                            <TextBox Text="{Binding AiTaskResult.OptimizedPrompt, Mode=OneWay}"
                                    IsReadOnly="True"
                                    TextWrapping="Wrap"
                                    VerticalScrollBarVisibility="Auto"
                                    Height="200"
                                    FontFamily="Consolas"
                                    FontSize="11"
                                    Background="#F5F5F5"
                                    BorderBrush="{StaticResource IndigoDarkBrush}"
                                    BorderThickness="1"
                                    Padding="8"/>
                        </StackPanel>
                        
                        <!-- Anteprima File -->
                        <StackPanel>
                            <Grid Margin="0,0,0,10">
                                <TextBlock Text="ðŸ‘ Anteprima File Generato" 
                                          FontWeight="SemiBold" 
                                          FontSize="14"
                                          VerticalAlignment="Center"/>
                                <Button Content="ðŸ”„ Ricarica Anteprima"
                                       Click="ReloadFilePreview_Click"
                                       Background="{StaticResource IndigoPrimaryBrush}"
                                       Foreground="White"
                                       Padding="8,4"
                                       BorderThickness="0"
                                       Cursor="Hand"
                                       FontSize="11"
                                       HorizontalAlignment="Right"/>
                            </Grid>
                            <TextBox x:Name="FilePreviewTextBox"
                                    Text="{Binding AiTaskResult.FilePreview, Mode=OneWay}"
                                    IsReadOnly="True"
                                    TextWrapping="Wrap"
                                    VerticalScrollBarVisibility="Auto"
                                    Height="250"
                                    FontFamily="Consolas"
                                    FontSize="11"
                                    Background="#FAFAFA"
                                    BorderBrush="{StaticResource IndigoDarkBrush}"
                                    BorderThickness="1"
                                    Padding="8"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
                
                <!-- Log Agente -->
                <Border Style="{StaticResource CardBorderStyle}" Margin="0,0,0,15">
                    <StackPanel>
                        <Grid Margin="0,0,0,10">
                            <TextBlock Text="Log dell'Agente" Style="{StaticResource SubtitleTextStyle}" VerticalAlignment="Center"/>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Content="ðŸ”„ Aggiorna Log"
                                       Click="RefreshLogs_Click"
                                       IsEnabled="{Binding IsLoadingLogs, Converter={StaticResource InverseBoolConverter}}"
                                       Background="{StaticResource IndigoPrimaryBrush}"
                                       Foreground="White"
                                       Padding="10,5"
                                       Margin="0,0,10,0"
                                       BorderThickness="0"
                                       Cursor="Hand"
                                       FontSize="12"/>
                                
                                <Button x:Name="ToggleLogsButton"
                                       Content="ðŸ“‹ Mostra Log"
                                       Click="ToggleLogs_Click"
                                       Background="{StaticResource IndigoOrangeBrush}"
                                       Foreground="White"
                                       Padding="10,5"
                                       BorderThickness="0"
                                       Cursor="Hand"
                                       FontSize="12"/>
                            </StackPanel>
                        </Grid>
                        
                        <!-- Sezione Log (nascosta di default) -->
                        <StackPanel x:Name="LogsSection" Visibility="Collapsed">
                            <!-- Loading indicator -->
                            <TextBlock Text="Caricamento log..."
                                      FontStyle="Italic"
                                      Foreground="{StaticResource IndigoPrimaryBrush}"
                                      Margin="0,10,0,10"
                                      Visibility="{Binding IsLoadingLogs, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            
                            <!-- TextBox per i log -->
                            <TextBox x:Name="LogsTextBox"
                                    Text="{Binding LogsText, Mode=OneWay}"
                                    IsReadOnly="True"
                                    TextWrapping="NoWrap"
                                    VerticalScrollBarVisibility="Auto"
                                    HorizontalScrollBarVisibility="Auto"
                                    Height="250"
                                    Margin="0,10,0,10"
                                    FontFamily="Consolas"
                                    FontSize="11"
                                    Background="#F5F5F5"
                                    BorderBrush="{StaticResource IndigoDarkBrush}"
                                    BorderThickness="1"
                                    Padding="8"/>
                            
                            <!-- Info log count -->
                            <TextBlock Margin="0,5,0,0">
                                <Run Text="Totale eventi:" FontWeight="SemiBold"/>
                                <Run Text="{Binding LogCount, Mode=OneWay}"/>
                                <Run Text=" | Auto-refresh: "/>
                                <Run Text="{Binding IsAutoRefreshEnabled, Mode=OneWay}" FontWeight="SemiBold"/>
                            </TextBlock>
                            
                            <!-- Toggle auto-refresh -->
                            <CheckBox Content="Abilita auto-refresh (ogni 5 secondi)"
                                     IsChecked="{Binding IsAutoRefreshEnabled}"
                                     Margin="0,10,0,0"
                                     Foreground="{StaticResource IndigoDarkBrush}"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>
        
        <!-- Pulsanti -->
        <StackPanel Grid.Row="2" 
                   Orientation="Horizontal" 
                   HorizontalAlignment="Right" 
                   Margin="0,20,0,0">
            <Button Content="Test Agent"
                   Command="{Binding TestAgentCommand}"
                   IsEnabled="{Binding IsTesting, Converter={StaticResource InverseBoolConverter}}"
                   Background="{StaticResource IndigoOrangeBrush}"
                   Foreground="White"
                   Padding="15,8"
                   Margin="0,0,10,0"
                   BorderThickness="0"
                   Cursor="Hand"/>
            
            <TextBlock Text="Testingâ€¦"
                      VerticalAlignment="Center"
                      FontSize="12"
                      FontStyle="Italic"
                      Foreground="{StaticResource IndigoPrimaryBrush}"
                      Margin="0,0,10,0"
                      Visibility="{Binding IsTesting, Converter={StaticResource BoolToVisibilityConverter}}"/>
            
            <Button Content="Chiudi" 
                   Click="CloseButton_Click"
                   Background="{StaticResource IndigoDarkBrush}"
                   Foreground="White"
                   Padding="15,8"
                   BorderThickness="0"
                   Cursor="Hand"/>
        </StackPanel>
    </Grid>
</Window>
